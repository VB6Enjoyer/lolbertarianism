<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancapistan Tycoon: The Free Market Simulator</title>
    <style>
        :root {
            --ancap-yellow: #F7D02C;
            --ancap-black: #1a1a1a;
            --anime-pink: #FFB7C5;
            --bg-color: #fdfdfd;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Draggable Sticker Background */
        #sticker-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            overflow: hidden;
            pointer-events: none;
            /* Allow clicks to pass through to the UI below */
        }

        .sticker {
            position: absolute;
            cursor: grab;
            transition: transform 0.1s, top 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: bold;
            text-align: center;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.1));
            pointer-events: auto;
            /* Make individual stickers clickable/draggable */
        }

        .sticker:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .sticker.text {
            background: white;
            padding: 5px 10px;
            border: 2px solid black;
            font-size: 14px;
            max-width: 150px;
        }

        .sticker.img-rep {
            font-size: 40px;
        }

        .sticker.image {
            width: 60px;
            padding: 3px;
            filter: none !important;
        }

        .sticker.image img {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }

        /* The Game UI */
        #game-ui {
            z-index: 5;
            display: flex;
            flex-direction: row;
            height: 100%;
            pointer-events: none;
            /* Let clicks pass through to stickers where empty */
        }

        /* Left Panel: The Clicker */
        .panel {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border: 4px solid var(--ancap-black);
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 8px 8px 0px var(--ancap-yellow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #clicker-panel {
            flex: 1;
            justify-content: center;
            min-width: 300px;
        }

        #shop-panel {
            flex: 1;
            overflow-y: auto;
            min-width: 300px;
        }

        h1 {
            font-size: 2rem;
            margin: 0;
            text-transform: uppercase;
            color: var(--ancap-black);
            text-shadow: 2px 2px 0px var(--ancap-yellow);
        }

        .score-display {
            font-size: 2.5rem;
            margin: 20px 0;
            color: green;
            font-family: monospace;
            font-weight: bold;
        }

        .sub-score {
            font-size: 1rem;
            color: #666;
            margin-bottom: 20px;
        }

        /* The Big Button */
        #main-btn {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, var(--ancap-yellow) 50%, var(--ancap-black) 50%);
            border-radius: 50%;
            border: 5px solid black;
            font-size: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            overflow: hidden;
        }

        #main-btn:active {
            transform: scale(0.95);
        }

        #main-btn::after {
            content: "DONT TREAD";
            position: absolute;
            bottom: 20px;
            font-size: 16px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        /* Shop Items */
        .shop-item {
            width: 100%;
            background: white;
            border: 2px solid black;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .shop-item:hover {
            background: #fffbe6;
        }

        .shop-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #eee;
        }

        #special-upgrades-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px dashed var(--ancap-black);
        }

        .special-upgrade {
            flex: 1;
            background: #fff;
            border: 2px solid var(--ancap-black);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .special-upgrade:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .special-upgrade.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #ddd;
            transform: none;
            box-shadow: none;
        }

        .special-upgrade-icon {
            font-size: 30px;
        }

        .special-upgrade-name {
            font-size: 0.8em;
            font-weight: bold;
            margin: 5px 0;
        }

        .special-upgrade-cost {
            font-size: 0.7em;
            color: #d35400;
        }

        .item-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .item-icon img {
            height: 40px;
            /* Match font size */
            width: auto;
            vertical-align: middle;
            /* Align with text */
        }

        .item-info {
            flex-grow: 1;
            text-align: left;
        }

        .item-name {
            font-weight: bold;
            display: block;
        }

        .item-cost {
            color: #d35400;
            font-size: 0.9em;
        }

        /* Floating Text Animation */
        .floater {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 100;
            text-shadow: 1px 1px 0 #fff;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-50px) scale(1.5);
                opacity: 0;
            }
        }

        /* Tax Raid Event */
        #raid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.5);
            z-index: 999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: flash 0.5s infinite;
        }

        @keyframes flash {
            0% {
                background: rgba(255, 0, 0, 0.3);
            }

            50% {
                background: rgba(255, 0, 0, 0.6);
            }

            100% {
                background: rgba(255, 0, 0, 0.3);
            }
        }

        #raid-box {
            background: white;
            padding: 30px;
            border: 5px solid red;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 0 20px red;
        }

        .btn-evade {
            background: var(--ancap-black);
            color: var(--ancap-yellow);
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 5px;
        }

        .btn-evade:hover {
            transform: scale(1.05);
        }

        .btn-reshuffle {
            background: var(--ancap-black);
            color: var(--ancap-yellow);
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 5px;
            font-family: inherit;
        }

        .btn-reshuffle:hover {
            transform: scale(1.05);
        }

        /* CSS Shapes for Flags */
        .flag-ancap {
            width: 70px;
            height: 50px;
            background: linear-gradient(135deg, var(--ancap-yellow) 50%, var(--ancap-black) 50%);
            border: 1px solid black;
            display: inline-block;
        }

        .flag-eu-cross {
            width: 60px;
            height: 40px;
            background: #003399;
            position: relative;
            border: 1px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .flag-eu-cross::after {
            content: "‚ùå";
            position: absolute;
            font-size: 25px;
            color: red;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 800px) {
            #game-ui {
                flex-direction: column;
            }

            .panel {
                margin: 10px;
                padding: 10px;
                flex: 1;
            }

            #main-btn {
                width: 150px;
                height: 150px;
                font-size: 60px;
            }
        }
    </style>
</head>

<body>

    <!-- Draggable Background Elements (The Collage) -->
    <div id="sticker-container">
        <!-- Generated via JS for randomness -->
    </div>

    <!-- Main Game UI -->
    <div id="game-ui">
        <!-- Left: Clicker -->
        <div class="panel" id="clicker-panel">
            <h1>Ancapistan Tycoon</h1>
            <p style="font-size: 0.8em; color: #888;">"Taxation is Theft"</p>

            <div class="score-display">$<span id="score">0</span></div>
            <div class="sub-score">$<span id="income">0</span> / sec</div>

            <div id="main-btn" onclick="clickMain()">
                üêç
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <p><i>"I owe my rights to Libertarians &lt;3"</i></p>
                <div style="font-size: 30px; display: flex; align-items: center; justify-content: center; gap: 0.2em;">
                    üóΩ ü™ô <img src="img/pistol.png" style="height: 1em; pointer-events: none;">
                </div>
            </div>

            <button class="btn-reshuffle" onclick="reshuffleStickers()">Reshuffle Stickers</button>
        </div>

        <!-- Right: Shop -->
        <div class="panel" id="shop-panel">
            <h2>The Free Market</h2>
            <div id="special-upgrades-container">
                <!-- Special upgrades injected here -->
            </div>
            <div id="shop-list">
                <!-- Shop items injected here -->
            </div>
        </div>
    </div>

    <!-- Raid Event Overlay -->
    <div id="raid-overlay">
        <div id="raid-box">
            <h1>üö® THE FED IS HERE! üö®</h1>
            <p>They want to audit your crypto wallet!</p>
            <p style="font-size: 40px;">üëÆ‚Äç‚ôÇÔ∏èüöîüìâ</p>
            <button class="btn-evade" onclick="evadeTax()">HIDE ASSETS!</button>
        </div>
    </div>

    <script>
        // Game State
        let score = 0;
        let income = 0;
        let clickValue = 1;
        let raidActive = false;
        let raidTimer = null;

        // Perk State
        let clickMultiplier = 1;
        let critChance = 0;
        let passiveMultiplier = 1;
        let incomeToClickPercent = 0;
        let raidEvasionChance = 0;


        // Upgrades Configuration
        const upgrades = [
            { id: 1, name: "Buy theory book", icon: "üìô", cost: 15, income: 0, clickBonus: 1, type: "click", lore: "It all starts with an idea. Read the sacred texts." },
            { id: 2, name: "Unlicensed lemonade stand", icon: "üçã", cost: 25, income: 1, clickBonus: 0, type: "passive", lore: "Where 6-year-olds learn the state is the enemy." },
            { id: 3, name: "Buy AK-47", icon: "<img src='img/ak47.png'>", cost: 800, income: 0, clickBonus: 5, type: "click", lore: "An armed society is a polite society. And a profitable one." },
            { id: 4, name: "Raw milk smuggling ring", icon: "ü•õ", cost: 2000, income: 10, clickBonus: 0, type: "passive", lore: "The FDA can't stop the signal. Or the delicious, unpasteurized profits." },
            { id: 5, name: "Homestead empty land", icon: "üè°", cost: 5000, income: 0, clickBonus: 10, type: "click", lore: "If you mix your labor with it, it's yours. John Locke said so." },
            { id: 6, name: "Overseas crypto farm", icon: "ü™ô", cost: 10000, income: 25, type: "passive", lore: "Somewhere off in South East Asia. Untraceable, unseizable, and unstoppable. The perfect asset for a free individual." },
            { id: 7, name: "Invoke the invisible hand", icon: "üñêÔ∏è", cost: 50000, income: 0, clickBonus: 50, type: "click", lore: "Adam Smith's ghost now guides your clicking finger towards maximum efficiency." },
            { id: 8, name: "Privatize roads", icon: "üöß", cost: 200000, income: 100, clickBonus: 0, type: "passive", lore: "Who will build the roads? You will. And you'll charge a toll." },
            { id: 9, name: "Hire PMC", icon: "ü™ñ", cost: 500000, income: 0, clickBonus: 100, type: "click", lore: "Make your life easier and enforce the NAP through a Private Military Contractor." },
            { id: 10, name: "Seasteading platform", icon: "üåä", cost: 1000000, income: 500, clickBonus: 0, type: "passive", lore: "Escape the clutches of terrestrial governments by building your own nation on the high seas." },
            { id: 11, name: "Recreational McNuke silo", icon: "‚ò¢Ô∏è", cost: 10000000, income: 0, clickBonus: 500, type: "click", lore: "For defending your property against particularly aggressive trespassers. Or just for fun." },
            { id: 12, name: "Homestead the moon", icon: "üåë", cost: 75000000, income: 1000, clickBonus: 0, type: "passive", lore: "One small step for man, one giant leap for private property." },
            { id: 13, name: "Interplanetary drug smuggling", icon: "üíä", cost: 250000000, income: 0, clickBonus: 1000, type: "click", lore: "The war on drugs doesn't apply in zero gravity." },
            { id: 14, name: "Privatize solar system", icon: "üåå", cost: 1000000000, income: 10000, clickBonus: 0, type: "passive", lore: "Why stop at one planet? It's all un-homesteaded real estate." },
        ];

        const specialUpgrades = [
            { id: 'su1', name: "Austrian Knowledge", icon: "üß†", cost: 250000, effect: 'crit', value: 0.05, purchased: false, description: "5% chance for a Critical Click (x5 value)!", lore: "You understand that value is subjective, but crits are objectively awesome." },
            { id: 'su2', name: "Golden Standard", icon: "ü™ô", cost: 1000000, effect: 'click_multiplier', value: 2, purchased: false, description: "Doubles the value of each click!", lore: "Return to sound money. Every dollar you make is now backed by pure, unadulterated value." },
            { id: 'su3', name: "Praxeology", icon: "üìà", cost: 5000000, effect: 'crit', value: 0.10, purchased: false, description: "Increases Critical Click chance by 10%!", lore: "The study of human action leads you to one conclusion: act to get more critical clicks." },
            { id: 'su4', name: "Capital Accumulation", icon: "üè≠", cost: 15000000, effect: 'passive_multiplier', value: 1.5, purchased: false, description: "Increases all passive income by 50%!", lore: "Your capital is no longer just working, it's putting in overtime. The compounding returns of liberty." },
            { id: 'su5', name: "Agorism", icon: "üè¥", cost: 50000000, effect: 'income_to_click', value: 0.01, purchased: false, description: "Adds 1% of your income-per-second to your click value.", lore: "Engage in counter-economics. Every part of your enterprise now fuels your direct action." },
            { id: 'su6', name: "Shell Companies", icon: "üè¢", cost: 100000000, effect: 'raid_evasion', value: 0.5, purchased: false, description: "Gain a 50% chance to automatically evade Fed raids.", lore: "A labyrinth of paperwork and legal entities makes you a ghost to the State." }
        ];

        // Collage Content for Background
        const stickersData = [
            // Quotes
            { type: 'text', category: "quote", content: "Taxation is theft!", },
            { type: 'text', category: "quote", content: "End! The! Fed!" },
            { type: 'text', category: "quote", content: "Free Market Enjoyer" },
            { type: 'text', category: "quote", content: "RESPECT THE NAP!" },
            { type: 'text', category: "quote", content: "Neo-Feudalist Bootlicker" },
            { type: 'text', category: "quote", content: "Agorism Now!" },
            { type: 'text', category: "quote", content: "Buy crypto!" },
            { type: 'text', category: "quote", content: "Commies want to take my stuff!" },
            { type: 'text', category: "quote", content: "Return to sound money!" },
            { type: 'text', category: "quote", content: "No free lunch!!!" },
            { type: 'text', category: "quote", content: "DO NOT TREAD" },
            { type: 'text', category: "quote", content: "Live and let live" },
            { type: 'text', category: "quote", content: "I love my M249 and my weed farm" },
            { type: 'text', category: "quote", content: "End the drug war!" },
            { type: 'text', category: "quote", content: "I would privatize the sun" },
            { type: 'text', category: "quote", content: "Rothbard my beloved ‚ù§Ô∏è" },
            { type: 'text', category: "quote", content: "FUERA!" },
            { type: 'text', category: "quote", content: "¬°VIVA LA LIBERTAD CARAJO!" },
            { type: 'text', category: "quote", content: "üáøüáø" },
            { type: 'text', category: "quote", content: "Ancapistan in my head" },
            { type: 'text', category: "quote", content: "So to speak" },
            { type: 'text', category: "quote", content: "Abolish IP" },
            { type: 'text', category: "quote", content: "ACAB" },
            { type: 'text', category: "quote", content: "1000 üá±üáÆ" },
            { type: 'text', category: "quote", content: "Support piracy!" },
            { type: 'text', category: "quote", content: "Tu ne cede malis sed contra audentior ito" },
            { type: 'text', category: "quote", content: "The best government is no government at all" },
            { type: 'text', category: "quote", content: "Why not try freedom?" },
            // Emotes
            { type: 'emoji', category: "emoji", content: "üêç" }, // Gadsden
            { type: 'emoji', category: "emoji", content: "üíâ" },
            { type: 'emoji', category: "emoji", content: "üìâ" },
            { type: 'emoji', category: "emoji", content: "üìà" },
            { type: 'emoji', category: "emoji", content: "üöÅ" }, // Pinochet helicopter
            { type: 'emoji', category: "emoji", content: "üí∞" }, // Money bag
            { type: 'emoji', category: "emoji", content: "ü¶î" }, // Libertarian Porcupine
            { type: 'emoji', category: "emoji", content: "ü™ô" }, // Sound money/gold
            { type: 'emoji', category: "emoji", content: "üá±üáÆ" },
            { type: 'emoji', category: "emoji", content: "‚ò¢Ô∏è" },
            { type: 'emoji', category: "emoji", content: "üè¥‚Äç‚ò†Ô∏è" },
            { type: 'emoji', category: "emoji", content: "üóΩ" },
            { type: 'emoji', category: "emoji", content: "üíä" },
            // HTML
            { type: 'html', category: "html", content: '<div class="flag-ancap"></div>' },
            { type: 'html', category: "html", content: '<div class="flag-eu-cross">üá™üá∫</div>' },
            // People
            { type: 'image', category: "person", content: 'img/rothbard.png' },
            { type: 'image', category: "person", content: 'img/hoppe.png' },
            { type: 'image', category: "person", content: 'img/mises.png' },
            { type: 'image', category: "person", content: 'img/kinsella.png' },
            { type: 'image', category: "person", content: 'img/tucker.png' },
            { type: 'image', category: "person", content: 'img/hayek.png' },
            { type: 'image', category: "person", content: 'img/ronpaul.png' },
            { type: 'image', category: "person", content: 'img/menger.png' },
            { type: 'image', category: "person", content: 'img/bohmbawerk.png' },
            { type: 'image', category: "person", content: 'img/hazlitt.png' },
            { type: 'image', category: "person", content: 'img/murphy.png' },
            { type: 'image', category: "person", content: 'img/kirzner.png' },
            { type: 'image', category: "person", content: 'img/gordon.png' },
            { type: 'image', category: "person", content: 'img/lewrockwell.png' },
            { type: 'image', category: "person", content: 'img/caplan.png' },
            { type: 'image', category: "person", content: 'img/salerno.png' },
            { type: 'image', category: "person", content: 'img/woods.png' },
            { type: 'image', category: "person", content: 'img/block.png' },
            { type: 'image', category: "person", content: 'img/bylund.png' },
            { type: 'image', category: "person", content: 'img/nock.png' },
            { type: 'image', category: "person", content: 'img/hansen.png' },
            { type: 'image', category: "person", content: 'img/dfriedman.png' },
            { type: 'image', category: "person", content: 'img/deist.png' },
            { type: 'image', category: "person", content: 'img/hulsmann.png' },
            { type: 'image', category: "person", content: 'img/ammous.png' },
            { type: 'image', category: "person", content: 'img/dilorenzo.png' },
            { type: 'image', category: "person", content: 'img/bagus.png' },
            { type: 'image', category: "person", content: 'img/jhs.png' },
            { type: 'image', category: "person", content: 'img/milei.png' },
            // Organizations 
            { type: 'image', category: "organization", content: 'img/misesinstitute.png' },
            { type: 'image', category: "organization", content: 'img/liberland.svg' },
            // Items
            { type: 'image', category: "item", content: 'img/pistol.png' },
            { type: 'image', category: "item", content: 'img/m249.png' },
            { type: 'image', category: "item", content: 'img/ak47.png' },
        ];

        // Initialize
        window.onload = function () {
            // Initialize upgrades with owned count and base cost
            upgrades.forEach(u => {
                u.baseCost = u.cost;
                u.owned = 0;
            });

            loadGame(); // Load progress before rendering

            renderShop();
            renderSpecialUpgrades();
            spawnStickers();
            setInterval(gameLoop, 1000);
            setInterval(tryRaid, 30000); // Chance of raid every 30s
            setInterval(saveGame, 5000); // Save progress every 5 seconds
        };

        // Core Game Logic
        function clickMain() {
            if (raidActive) return;

            let baseClick = clickValue + (income * incomeToClickPercent);
            let currentClickValue = baseClick * clickMultiplier;
            let isCrit = Math.random() < critChance;

            if (isCrit) {
                currentClickValue *= 5; // 5x value on crit
                spawnFloater(event.clientX, event.clientY, `CRIT! +$${currentClickValue.toLocaleString()}`, "orange");
            } else {
                spawnFloater(event.clientX, event.clientY, `+$${currentClickValue.toLocaleString()}`);
            }
            addScore(currentClickValue);

            // Random chance for meme text
            if (Math.random() < 0.1) {
                const phrases = ["Freedom!", "My Property!", "Based", "No Step!"];
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                setTimeout(() => spawnFloater(event.clientX + (Math.random() * 40 - 20), event.clientY - 40, phrase, "black"), 100);
            }
        }

        function addScore(amount) {
            score += amount;
            updateUI();
        }

        function gameLoop() {
            if (!raidActive) {
                score += (income * passiveMultiplier);
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('score').innerText = Math.floor(score).toLocaleString();
            document.getElementById('income').innerText = (income * passiveMultiplier).toLocaleString();

            // Update special upgrade buttons
            specialUpgrades.forEach(su => {
                const btn = document.getElementById(`btn-${su.id}`);
                if (btn) {
                    if (score >= su.cost && !su.purchased) {
                        btn.classList.remove('disabled');
                    } else {
                        btn.classList.add('disabled');
                    }
                }
            });

            // Update shop buttons availability
            upgrades.forEach(u => {
                const btn = document.getElementById(`btn-${u.id}`);
                if (btn) {
                    if (score >= u.cost) {
                        btn.classList.remove('disabled');
                    } else {
                        btn.classList.add('disabled');
                    }
                }
            });
        }

        // Shop Logic
        function renderShop() {
            const container = document.getElementById('shop-list');
            container.innerHTML = "";
            upgrades.forEach(u => {
                const div = document.createElement('div');
                div.className = "shop-item disabled";
                div.id = `btn-${u.id}`;
                div.onclick = () => buyUpgrade(u);
                div.title = u.lore || '';
                div.innerHTML = `
                    <div class="item-icon">${u.icon}</div>
                    <div class="item-info">
                        <span class="item-name">${u.name}</span>
                        <span class="item-cost">$${u.cost.toLocaleString()}</span>
                    </div>
                    <div style="font-size:0.8em; color:#666;">
                        ${u.type === 'passive' ? '+' + u.income + '/s' : '+' + u.clickBonus + '/click'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function buyUpgrade(item) {
            if (score >= item.cost) {
                score -= item.cost;
                item.owned++;

                const growthFactor = 1.15;
                item.cost = Math.ceil(item.baseCost * Math.pow(growthFactor, item.owned));

                if (item.type === 'passive') {
                    income += item.income;
                } else {
                    clickValue += item.clickBonus;
                }

                spawnFloater(window.innerWidth / 2, window.innerHeight / 2, "PURCHASED!", "green");
                renderShop(); // Re-render to update costs
                updateUI();
            }
        }

        function renderSpecialUpgrades() {
            const container = document.getElementById('special-upgrades-container');
            container.innerHTML = "";
            specialUpgrades.forEach(su => {
                const div = document.createElement('div');
                div.className = "special-upgrade disabled";
                if (su.purchased) {
                    div.classList.add('disabled');
                }
                div.id = `btn-${su.id}`;
                div.onclick = () => buySpecialUpgrade(su);
                div.title = `${su.description}\n\n${su.lore}`;
                div.innerHTML = `
                    <div class="special-upgrade-icon">${su.icon}</div>
                    <div class="special-upgrade-name">${su.name}</div>
                    <div class="special-upgrade-cost">$${su.cost.toLocaleString()}</div>
                `;
                container.appendChild(div);
            });
        }

        function buySpecialUpgrade(item) {
            if (score >= item.cost && !item.purchased) {
                score -= item.cost;
                item.purchased = true;

                if (item.effect === 'crit') {
                    critChance += item.value;
                } else if (item.effect === 'click_multiplier') {
                    clickMultiplier *= item.value;
                } else if (item.effect === 'passive_multiplier') {
                    passiveMultiplier *= item.value;
                } else if (item.effect === 'income_to_click') {
                    incomeToClickPercent += item.value;
                } else if (item.effect === 'raid_evasion') {
                    raidEvasionChance += item.value;
                }

                spawnFloater(window.innerWidth / 2, window.innerHeight / 2, "PERK UNLOCKED!", "gold");
                renderSpecialUpgrades();
                updateUI();
            }
        }

        // Save and Load Logic
        function saveGame() {
            const saveData = {
                score: score,
                upgrades: upgrades.map(u => ({ id: u.id, owned: u.owned })),
                specialUpgrades: specialUpgrades.map(su => ({ id: su.id, purchased: su.purchased }))
            };
            localStorage.setItem('ancapTycoonSave', JSON.stringify(saveData));
            console.log("Game Saved!");
        }

        function loadGame() {
            const savedGame = localStorage.getItem('ancapTycoonSave');
            if (savedGame) {
                const data = JSON.parse(savedGame);

                score = data.score || 0;

                // Reset derived stats before recalculating
                income = 0;
                clickValue = 1;
                clickMultiplier = 1;
                critChance = 0;
                passiveMultiplier = 1;
                incomeToClickPercent = 0;
                raidEvasionChance = 0;

                // Load regular upgrades
                if (data.upgrades) {
                    data.upgrades.forEach(savedUpgrade => {
                        const gameUpgrade = upgrades.find(u => u.id === savedUpgrade.id);
                        if (gameUpgrade) {
                            gameUpgrade.owned = savedUpgrade.owned;
                            for (let i = 0; i < gameUpgrade.owned; i++) {
                                if (gameUpgrade.type === 'passive') income += gameUpgrade.income;
                                else clickValue += gameUpgrade.clickBonus;
                            }
                            const growthFactor = 1.15;
                            gameUpgrade.cost = Math.ceil(gameUpgrade.baseCost * Math.pow(growthFactor, gameUpgrade.owned));
                        }
                    });
                }

                // Load special upgrades and apply their effects
                if (data.specialUpgrades) {
                    data.specialUpgrades.forEach(savedSpecial => {
                        const gameSpecial = specialUpgrades.find(su => su.id === savedSpecial.id);
                        if (gameSpecial && savedSpecial.purchased) {
                            gameSpecial.purchased = true;
                            // Apply effects directly
                            if (gameSpecial.effect === 'crit') critChance += gameSpecial.value;
                            else if (gameSpecial.effect === 'click_multiplier') clickMultiplier *= gameSpecial.value;
                            else if (gameSpecial.effect === 'passive_multiplier') passiveMultiplier *= gameSpecial.value;
                            else if (gameSpecial.effect === 'income_to_click') incomeToClickPercent += gameSpecial.value;
                            else if (gameSpecial.effect === 'raid_evasion') raidEvasionChance += gameSpecial.value;
                        }
                    });
                }
                console.log("Game Loaded!");
            }
        }

        // Visual Effects
        function spawnFloater(x, y, text, color = "#2ecc71") {
            const el = document.createElement('div');
            el.className = 'floater';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function reshuffleStickers() {
            const container = document.getElementById('sticker-container');
            container.innerHTML = ''; // Clear existing stickers
            spawnStickers();
        }

        // Draggable Stickers Logic
        function spawnStickers() {
            const container = document.getElementById('sticker-container');
            const stickersToSpawn = [];

            const counts = {
                quote: 7,
                emoji: 7,
                html: 2,
                person: 5,
                organization: 2,
                item: 3
            };

            for (const category in counts) {
                const itemsInCategory = stickersData.filter(s => s.category === category);
                // Shuffle and pick
                const shuffled = itemsInCategory.sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, counts[category]);
                stickersToSpawn.push(...selected);
            }

            // Shuffle the final list to mix categories
            stickersToSpawn.sort(() => 0.5 - Math.random());

            stickersToSpawn.forEach((data, index) => {
                const el = document.createElement('div');
                el.className = 'sticker';

                // Calculate final position
                const finalLeft = (Math.random() * (window.innerWidth - 100)) + 'px';
                const finalTop = (Math.random() * (window.innerHeight - 100)) + 'px';

                // Set initial off-screen position
                el.style.left = finalLeft;
                el.style.top = '-200px';

                if (data.type === 'text') {
                    el.classList.add('text');
                    el.innerText = data.content;
                } else if (data.type === 'emoji') {
                    el.classList.add('img-rep');
                    el.innerText = data.content;
                    el.style.fontSize = (Math.random() * 40 + 30) + 'px';
                } else if (data.type === 'image') {
                    el.classList.add('image');
                    const img = document.createElement('img');
                    img.src = data.content;
                    el.appendChild(img);
                } else {
                    el.innerHTML = data.content;
                }
                el.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;

                makeDraggable(el);
                container.appendChild(el);

                // Trigger the animation to the final position after a short delay
                setTimeout(() => {
                    el.style.top = finalTop;
                }, 50 + index * 20); // Stagger the fall
            });
        }

        function makeDraggable(el) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            el.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                el.style.zIndex = 1000; // Bring to front
            });

            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    el.style.left = (initialLeft + dx) + 'px';
                    el.style.top = (initialTop + dy) + 'px';
                }
            });

            window.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    el.style.zIndex = 21;
                }
            });
        }

        // Raid Event Logic
        function tryRaid() {
            if (score > 5000 && Math.random() > 0.7) {
                if (Math.random() < raidEvasionChance) {
                    spawnFloater(window.innerWidth / 2, 50, "Raid Evaded!", "blue");
                    return; // Automatically evaded
                }

                raidActive = true;
                document.getElementById('raid-overlay').style.display = 'flex';
                // Penalty if ignored (simulated by just blocking income)
            }
        }

        function evadeTax() {
            raidActive = false;
            document.getElementById('raid-overlay').style.display = 'none';
            spawnFloater(window.innerWidth / 2, window.innerHeight / 2, "TAX EVADED!", "blue");
            addScore(100); // Bonus for evasion
        }

    </script>
</body>

</html>